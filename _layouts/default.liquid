<!doctype html>
<html lang="{{ site.lang }}">
  <!-- Head -->
  <head>
    {% if page.redirect %}
      {% if page.redirect == true %}
        {% assign redirect = site.baseurl | append: '/' %}
      {% elsif page.redirect contains '://' %}
        {% assign redirect = page.redirect %}
      {% else %}
        {% assign redirect = page.redirect | relative_url %}
      {% endif %}
      <meta http-equiv="refresh" content="3; url={{ redirect }}">
    {% endif %}
    {% include head.liquid %}
  </head>

  <!-- Body -->
  <body class="{% if site.navbar_fixed %}fixed-top-nav{% endif %} {% unless site.footer_fixed %}sticky-bottom-footer{% endunless %}">
    <!-- Header -->
    {% include header.liquid %}

    <!-- Content -->
    <div class="container mt-5" role="main">
      {% if page.toc and page.toc.sidebar %}
        {% if page.toc.sidebar == 'right' %}
          <div class="row">
            <!-- main content area -->
            <div class="col-sm-9">
              {{ content }}
            </div>
            <!-- sidebar, which will move to the top on a small screen -->
            <div class="col-sm-3">
              <nav id="toc-sidebar" class="sticky-top">
                <!-- The TOC is injected by JS or jekyll-toc plugin -->
              </nav>
            </div>
          </div>
        {% else %}
          <div class="row">
            <!-- sidebar (TOC on the left) -->
            <div class="col-sm-3">
              <nav id="toc-sidebar" class="sticky-top">
                <!-- The TOC is injected by JS or jekyll-toc plugin -->
              </nav>
            </div>
            <!-- main content area -->
            <div class="col-sm-9">
              {{ content }}
            </div>
          </div>
        {% endif %}
      {% else %}
        {{ content }}
      {% endif %}
    </div>

    <!-- Footer -->
    {% include footer.liquid %}

    <!-- JavaScripts -->
    {% include scripts/jquery.liquid %}
    {% include scripts/bootstrap.liquid %}
    {% include scripts/masonry.liquid %}
    {% include scripts/mermaid.liquid %}
    {% include scripts/diff2html.liquid %}
    {% include scripts/leaflet.liquid %}
    {% include scripts/chartjs.liquid %}
    {% include scripts/echarts.liquid %}
    {% include scripts/vega.liquid %}
    {% include scripts/tikzjax.liquid %}
    {% include scripts/typograms.liquid %}
    {% include scripts/misc.liquid %}
    {% include scripts/badges.liquid %}
    {% include scripts/mathjax.liquid %}
    {% include scripts/pseudocode.liquid %}
    {% include scripts/analytics.liquid %}
    {% include scripts/progressBar.liquid %}
    {% include scripts/wechatModal.liquid %}
    {% include scripts/imageLayouts.liquid %}
    {% include scripts/jekyll_tabs.liquid %}
    {% include scripts/back_to_top.liquid %}
    {% include scripts/search.liquid %}

    <!-- Inline JS snippet to append the Back link after TOC injection -->
    <script>
    window.addEventListener("load", function() {
      {% if page.back_link and page.back_text %}
      const linkHTML = `
        <div class="back-link">
          <a href="{{ page.back_link | relative_url }}">
            <!-- Arrow icon (inline SVG) -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              width="16"
              height="16"
              fill="currentColor"
            >
              <path d="M0 0h24v24H0z" fill="none"/>
              <path d="M8 7v4L2 6l6-5v4h5a8 8 0 1 1 0 16H4v-2h9a6 6 0 1 0 0-12H8z"/>
            </svg>
            <span>{{ page.back_text }}</span>
          </a>
        </div>
      `;

      const tocSidebar = document.getElementById("toc-sidebar");
      if (tocSidebar) {
        tocSidebar.insertAdjacentHTML('beforeend', linkHTML);
      }
      {% endif %}
    });
    </script>

    <!-- Inline JS to auto-number TOC items in #toc-sidebar -->
    <script>
    window.addEventListener("load", function() {
      // 1) Extract user offset from front matter or default=1
      {% assign offset_str = page.start_h1_number | default: "1" %}
      const userOffset = parseInt("{{ offset_str }}", 10);
      // e.g. if user sets 2 => userOffset=2. If none => userOffset=1

      // We'll define two cases:
      // A) If userOffset=2 => top-level headings => "3.1", "3.2" ...
      // B) If userOffset=1 => top-level => "1", "2", sub => "2.1" etc.
      // We'll handle that with a simple 'if' inside the logic.

      const rootUl = document.querySelector("#toc-sidebar > ul");
      if (!rootUl) return;

      function numberList(ulElement, prefix = "", startIndex = 1) {
        const liElements = ulElement.querySelectorAll(":scope > li");
        let index = startIndex;

        liElements.forEach(li => {
          let label;
          if (!prefix) {
            // top-level: check userOffset
            if (userOffset === 2) {
              // => first top-level heading => 3.1 => label = "3.index"
              const topLevel = userOffset + 1;  // 2+1=3
              label = `${topLevel}.${index}`;   // => "3.1"
            } else {
              // => userOffset=1 or anything else => top-level => "1", "2", "3"...
              // so label = index
              label = String(index);
            }
          } else {
            // nested => prefix.index => e.g. "3.2.1"
            label = `${prefix}.${index}`;
          }

          const link = li.querySelector(":scope > a");
          if (link) {
            link.textContent = label + " " + link.textContent;
          }

          // If nested <ul>, recurse with sub-level starting at 1
          const nestedUl = li.querySelector(":scope > ul");
          if (nestedUl) {
            numberList(nestedUl, label, 1);
          }

          index++;
        });
      }

      // 2) Call the function on the top-level <ul>, prefix="", startIndex=1
      numberList(rootUl, "", 1);
    });
    </script>
  </body>
</html>